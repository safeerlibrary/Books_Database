<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School Books Record (Live)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navigation -->
  <nav class="w-full bg-white shadow p-3 flex flex-wrap items-center gap-3 justify-between">
    <div class="flex items-center gap-2">
      <div class="text-xl font-bold">ðŸ“š School Books</div>
      <div class="text-sm text-gray-500 hidden md:block">Live from Google Sheets</div>
    </div>

    <div class="flex-1 max-w-md">
      <input id="searchInput" type="text" placeholder="Search by book name, subject, or note..."
        class="w-full border rounded-lg p-2 shadow-sm" />
    </div>

    <div class="flex items-center gap-2">
      <select id="classSelect" class="border rounded-lg p-2">
        <option>All Classes</option>
      </select>

      <button id="reloadBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">Reload Data</button>
    </div>
  </nav>

  <div class="p-4 text-sm text-gray-600">
    Showing <span id="countDisplay">0</span> records
  </div>

  <div id="cardsContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    <div class="text-gray-400 text-center col-span-full">Loading data from Google Sheets...</div>
  </div>

  <script>
    // âœ… Your live Google Sheet CSV link
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSB63Lx0NFr6yE9-EhAjkW8KoxCHrGTzpMniovT8auFrAg3PK6DUrtuQNYr3HVxjjuo5Q6tfA0BEk2m/pub?output=csv";

    const cardsContainer = document.getElementById("cardsContainer");
    const classSelect = document.getElementById("classSelect");
    const searchInput = document.getElementById("searchInput");
    const countDisplay = document.getElementById("countDisplay");
    const reloadBtn = document.getElementById("reloadBtn");

    let allRows = [];
    let filteredRows = [];

    const defaultClasses = [
      "Nursery", "Reception", "Year 1", "Year 2", "Year 3", "Year 4",
      "Year 5", "Year 6", "Year 7", "Year 8", "Year 9", "Question Paper"
    ];

    function resetClassOptions() {
      classSelect.innerHTML = "<option>All Classes</option>";
      defaultClasses.forEach(cls => {
        const opt = document.createElement("option");
        opt.textContent = cls;
        classSelect.appendChild(opt);
      });
    }
    resetClassOptions();

    // âœ… Fetch CSV data from Google Sheets
    async function fetchSheetData() {
      cardsContainer.innerHTML =
        '<div class="col-span-full text-gray-400 text-center py-12">Loading data from Google Sheets...</div>';

      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error("Failed to fetch");
        const csvText = await res.text();

        // Parse CSV text manually
        const rows = csvText.trim().split("\n").map(r => r.split(","));
        const headers = rows[0].map(h => h.trim());
        allRows = rows.slice(1).map(r => {
          const obj = {};
          headers.forEach((h, i) => obj[h] = r[i] ? r[i].trim() : "");
          return normalizeRow(obj);
        });

        applyFilter();
      } catch (err) {
        console.error(err);
        cardsContainer.innerHTML =
          '<div class="col-span-full text-red-500 text-center py-12">Error loading data from Google Sheets.</div>';
      }
    }

    // Normalize column names
    function normalizeRow(row) {
      return {
        SL: row["SL."] || "",
        Subject: row["Subject"] || "",
        "Book Name": row["Book Name"] || "",
        Quantity: row["Quentity"] || "",
        Sale: row["Sale"] || "",
        "Tkn By Teacher": row["Tkn By Teacher"] || "",
        Return: row["Return"] || "",
        "New Receive": row["New Recive"] || "",
        "Total Book": row["Total Book"] || "",
        Note: row["Note"] || "",
        _sheet: row["Subject"] || "Unknown"
      };
    }

    // âœ… Multi-word search system
    function applyFilter() {
      const selected = classSelect.value;
      const query = searchInput.value.toLowerCase().trim();
      const queryWords = query.split(/\s+/).filter(Boolean);

      filteredRows = allRows.filter((r) => {
        let ok = true;
        if (selected !== "All Classes") ok = r._sheet === selected;
        if (queryWords.length) {
          const combined = [
            r["Book Name"],
            r.Subject,
            r.Note,
            r._sheet,
          ].join(" ").toLowerCase();
          ok = ok && queryWords.every(w => combined.includes(w));
        }
        return ok;
      });

      renderCards();
    }

    // âœ… Render cards
    function renderCards() {
      cardsContainer.innerHTML = "";
      countDisplay.textContent = filteredRows.length;

      if (!filteredRows.length) {
        cardsContainer.innerHTML =
          '<div class="col-span-full text-gray-400 text-center py-12">No data found.</div>';
        return;
      }

      filteredRows.forEach((r, i) => {
        const card = document.createElement("article");
        card.className = "bg-white rounded-2xl p-4 shadow hover:shadow-md transition text-sm";
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold">${r["Book Name"] || "(No Name)"}</h3>
              <p class="text-gray-500">${r.Subject || "Unknown"} â€¢ ${r._sheet}</p>
            </div>
            <div class="text-xs text-gray-400">SL: ${r.SL || i + 1}</div>
          </div>
          <dl class="mt-3 grid grid-cols-2 gap-2">
            <div><dt class="text-gray-400">Quantity</dt><dd>${r.Quantity}</dd></div>
            <div><dt class="text-gray-400">Sale</dt><dd>${r.Sale}</dd></div>
            <div><dt class="text-gray-400">Tkn By Teacher</dt><dd>${r["Tkn By Teacher"]}</dd></div>
            <div><dt class="text-gray-400">Return</dt><dd>${r.Return}</dd></div>
            <div><dt class="text-gray-400">New Receive</dt><dd>${r["New Receive"]}</dd></div>
            <div><dt class="text-gray-400">Total Book</dt><dd class="font-semibold text-blue-600">${r["Total Book"]}</dd></div>
          </dl>
          ${r.Note ? `<p class="mt-2 text-xs text-gray-500">Note: ${r.Note}</p>` : ""}
        `;
        cardsContainer.appendChild(card);
      });
    }

    // âœ… Events
    searchInput.addEventListener("input", applyFilter);
    classSelect.addEventListener("change", applyFilter);
    reloadBtn.addEventListener("click", fetchSheetData);

    // Load data on start
    fetchSheetData();
  </script>
</body>
</html>
