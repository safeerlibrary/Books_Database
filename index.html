<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safeer Library (Live)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navigation -->
  <nav class="w-full bg-white shadow p-3 flex flex-wrap items-center gap-3 justify-between">
    <div class="flex items-center gap-2">
      <img src="image.png" alt="Logo" class="w-8 h-8 rounded-lg" />
      <div>
        <div class="text-xl font-bold">Safeer Library</div>
        <div class="text-sm text-gray-500 hidden md:block">Made By: Md Nurul Alam Niloy</div>
      </div>
    </div>

    <div class="flex-1 max-w-md order-3 w-full md:w-auto md:order-none">
      <input id="searchInput" type="text" placeholder="Search by book name, subject, or note..."
        class="w-full border rounded-lg p-2 shadow-sm" />
    </div>

    <div class="flex items-center gap-2">
      <select id="classSelect" class="border rounded-lg p-2"></select>
      <button id="reloadBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">Reload Data</button>
    </div>
  </nav>

  <!-- Last Updated Info -->
  <div class="px-4 py-2 text-sm text-gray-600 flex items-center gap-2">
    <span id="lastUpdated">Last updated: checking...</span>
  </div>

  <div class="p-4 text-sm text-gray-600">
    Showing <span id="countDisplay">0</span> records
  </div>

  <div id="cardsContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    <div class="text-gray-400 text-center col-span-full">Loading data...</div>
  </div>

<script>
// ---- CLASS LIST + GID MAP ----
const SHEETS = [
  { name: "Nursery", gid: "2090458225" },
  { name: "Reception", gid: "1846395443" },
  { name: "Year 1", gid: "1978300943" },
  { name: "Year 2", gid: "862928818" },
  { name: "Year 3", gid: "773616211" },
  { name: "Year 4", gid: "1733381232" },
  { name: "Year 5", gid: "358390641" },
  { name: "Year 6", gid: "1319776648" },
  { name: "Year 7", gid: "1802575893" },
  { name: "Year 8", gid: "1794593989" },
  { name: "Year 9", gid: "157753930" },
  { name: "Question Paper", gid: "882635163" }
];

// âœ… Correct Google Sheet CSV Base URL
const BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSB63Lx0NFr6yE9-EhAjkW8KoxCHrGTzpMniovT8auFrAg3PK6DUrtuQNYr3HVxjjuo5Q6tfA0BEk2m/pub?gid=";

// ðŸ•’ Google Sheets "last update" API URL
// Replace this sheetId with your actual one (you can get it from your Google Sheets URL)
const SHEET_ID = "1vSB63Lx0NFr6yE9-EhAjkW8KoxCHrGTzpMniovT8auFrAg3PK6DUrtuQNYr3HVxjjuo5Q6tfA0BEk2m";
const META_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

const cardsContainer = document.getElementById("cardsContainer");
const classSelect = document.getElementById("classSelect");
const searchInput = document.getElementById("searchInput");
const reloadBtn = document.getElementById("reloadBtn");
const countDisplay = document.getElementById("countDisplay");
const lastUpdated = document.getElementById("lastUpdated");

let allRows = [];
let filteredRows = [];

// ---- Setup Class Dropdown ----
classSelect.innerHTML = `<option>All Classes</option>` + SHEETS.map(s => `<option>${s.name}</option>`).join("");

// âœ… Fetch Last Updated Time
async function fetchLastUpdated() {
  try {
    const res = await fetch(META_URL);
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2)); // parse Google Sheets JSON
    const updatedTime = json.table.updated;
    const formatted = new Date(updatedTime).toLocaleString();
    lastUpdated.textContent = `Last updated: ${formatted}`;
  } catch (e) {
    console.error("Failed to fetch last updated time", e);
    lastUpdated.textContent = "Last updated: unavailable";
  }
}

// ---- Fetch All Sheets ----
async function fetchAllSheets() {
  cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12">Loading data...</div>';
  lastUpdated.textContent = "Last updated: checking...";

  try {
    const allData = await Promise.all(
      SHEETS.map(s => fetch(BASE + s.gid + "&single=true&output=csv").then(r => r.text()))
    );

    allRows = [];

    allData.forEach((csvText, i) => {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      parsed.data.forEach(row => {
        row._sheet = SHEETS[i].name;
        allRows.push(normalizeRow(row));
      });
    });

    await fetchLastUpdated();
    applyFilter();
  } catch (e) {
    console.error(e);
    cardsContainer.innerHTML = '<div class="col-span-full text-red-500 text-center py-12">Failed to load data.</div>';
    lastUpdated.textContent = "Last updated: unavailable";
  }
}

// ---- Normalize Each Row ----
function normalizeRow(r) {
  return {
    SL: r["SL."] || "",
    Subject: r["Subject"] || "",
    "Book Name": r["Book Name"] || "",
    Quantity: r["Quentity"] || r["Quantity"] || "",
    Sale: r["Sale"] || "",
    "Tkn By Teacher": r["Tkn By Teacher"] || r["Taken By Teacher"] || "",
    Return: r["Return"] || "",
    "New Receive": r["New Recive"] || r["New Receive"] || "",
    "Total Book": r["Total Book"] || "",
    Note: r["Note"] || "",
    _sheet: r._sheet
  };
}

// âœ… ---- Apply Filter (Improved Multi-word Search) ----
function applyFilter() {
  const selected = classSelect.value;
  const query = searchInput.value.toLowerCase().trim();
  const queryWords = query.split(/\s+/).filter(Boolean);

  filteredRows = allRows.filter((r) => {
    let ok = selected === "All Classes" || r._sheet === selected;

    if (queryWords.length) {
      const combinedText = [
        r["Book Name"],
        r.Subject,
        r.Note,
        r._sheet
      ].join(" ").toLowerCase();

      ok = ok && queryWords.every((word) => combinedText.includes(word));
    }

    return ok;
  });

  renderCards();
}

// ---- Render Cards ----
function renderCards() {
  cardsContainer.innerHTML = "";
  countDisplay.textContent = filteredRows.length;

  if (!filteredRows.length) {
    cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12">No records found.</div>';
    return;
  }

  filteredRows.forEach(r => {
    cardsContainer.innerHTML += `
      <article class="bg-white rounded-2xl p-4 shadow hover:shadow-md transition text-sm">
        <h3 class="text-lg font-semibold">${r["Book Name"]}</h3>
        <p class="text-gray-500">${r.Subject} â€¢ <b>${r._sheet}</b></p>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <p>Quantity: ${r.Quantity}</p>
          <p>Sale: ${r.Sale}</p>
          <p>Teacher: ${r["Tkn By Teacher"]}</p>
          <p>Return: ${r.Return}</p>
          <p>New Receive: ${r["New Receive"]}</p>
          <p class="font-semibold text-blue-600">Total: ${r["Total Book"]}</p>
        </div>
        ${r.Note ? `<p class="mt-2 text-xs text-gray-500">Note: ${r.Note}</p>` : ""}
      </article>
    `;
  });
}

// ---- Event Listeners ----
searchInput.addEventListener("input", applyFilter);
classSelect.addEventListener("change", applyFilter);
reloadBtn.addEventListener("click", fetchAllSheets);

// ---- Load on Start ----
fetchAllSheets();
</script>

</body>
</html>

